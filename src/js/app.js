var sfarm=angular.module("sfarm",["ui.router","ui.bootstrap","cgNotify","ngAnimate","nvd3","oc.lazyLoad","ui.grid","ui.grid.selection","ui-notification","checklist-model","ui.grid.resizeColumns","ui.grid.pagination","googlechart"]).constant("USER_ROLES",{all:"*",admin:"admin",guest:"guest"}).config(["$httpProvider",function(e){e.interceptors.push("reqInspect")}]).filter("ucf",function(){return function(e){return e.substring(0,1).toUpperCase()+e.slice(1)}}).filter("valueFilter",function(){return function(e){var t=e.id;e.value.substring(0,1);if("Temp"===e.type){var r=parseFloat(e.value)/10;return t+" : "+r+" â„ƒ "}if("Level"===e.type){var r=parseFloat(e.value)/10;return t+" : "+r+" % "}var r=parseFloat(e.value)/10;return t+" : "+r}}).config(["$animateProvider",function(e){e.classNameFilter(/^((?!(ui-grid-menu)).)*$/)}]),sfarm=angular.module("sfarm");sfarm.config(["$stateProvider","$urlRouterProvider","USER_ROLES",function(e,t,r){t.otherwise("/"),e.state("login",{url:"/login",templateUrl:"templates/login.html",controller:"LoginCtrl",data:{}}).state("app",{url:"/",templateUrl:"index.html",controller:"AppCtrl"}).state("app.dashboard",{url:"app/dashboard",templateUrl:"templates/dashboard.html",controller:"DashboardCtrl",parent:"app"}).state("app.rawdata",{url:"app/rawdata",templateUrl:"templates/rawdata.html",controller:"rawDataCtrl",parent:"app"}).state("admin",{url:"/admin",templateUrl:"admin/test.html",controller:"adminCtrl",resolve:{loadMyCtrl:["$ocLazyLoad",function(e){return e.load("admin/js/app.js")}]}}).state("admin.users",{url:"/users",parent:"admin",views:{display:{templateUrl:"admin/partials/users.html"}}}).state("admin.functions",{url:"/functionalities",parent:"admin",views:{display:{templateUrl:"admin/partials/functions.html"}}})}]);var sfarm=angular.module("sfarm");sfarm.directive("devicedata",function(){return{restrict:"E",scope:{reading:"="},templateUrl:"partials/reading.php"}}).directive("deviceSwitch",function(){return{restrict:"A",controller:"deviceStatusCtrl",link:function(e,t,r){t.bind("click",function(e){e.preventDefault(),e.stopPropagation()})}}}).directive("friendlyName",["$uibModal",function(e){return{restrict:"A",scope:{device:"="},link:function(t,r,a){r.bind("click",function(r){e.open({animation:!0,templateUrl:"partials/EditFriendlyModal.php",controller:"FriendlyNameEditorCtrl",resolve:{selectedDevice:function(){var e=t.$parent.device;return e}}}),r.preventDefault(),r.stopPropagation()})}}}]).directive("googleGraph",[function(e,t,r){return{restrict:"EA",templateUrl:"partials/googlegraph.html",controller:"testCtrl"}}]).controller("testCtrl",["$scope","mygraphFactory","$filter","$rootScope","$rootScope",function(e,t,r,a,a){e.trigger=function(){a.$emit("resizeMsg")}}]).directive("lastReading",function(){return{restrict:"A",link:function(e,t,r){var a=[],n=e.data[e.$index].readings;n.forEach(function(e,t){a.push(new Date(e.dt))});var o=Math.max.apply(null,a);e.data[e.$index].lread=new Date(o),n.forEach(function(t,r){new Date(t.dt).getTime()===new Date(o).getTime()&&(e.data[e.$index].lread=t)})}}}).directive("logBtn",function(){return{restrict:"A",link:function(e,t,r){t.bind("click",function(e){})}}}).directive("noClick",function(){return{restrict:"A",link:function(e,t,r){t.bind("click",function(e){e.preventDefault(),e.stopPropagation()})}}}).directive("flexibleDiv",function(){return{scope:{opts:"="},link:function(e,t,r){function a(){e.opts.chart.height=t.parent(0).height()-150}function n(){e.opts.chart.width=t.parent(0).width()-50}e.$watch(function(){return t.parent(0).height()},a),e.$watch(function(){return t.parent(0).width()},n)}}}).directive("uibTooltip",function(){return{restrict:"EA",link:function(){}}}).directive("resize",["$window",function(e){return function(t,r,a){var n=angular.element(e);e.innerWidth<a.hvalue?r.addClass("collapse"):r.removeClass("collapse"),n.bind("resize",function(){e.innerWidth<a.hvalue?r.addClass("collapse"):r.removeClass("collapse")})}}]).controller("uib-accordion",["$scope","device","Notification","Poller","$rootScope","$timeout","$state","$interval","$filter","mygraphFactory","$sce",function(e,t,r,a,n,o,i,s,l,c,u){e.isLoading=!0,e.graphLoading=!0,e.data=t.all().then(function(t){e.data=t,c.googleGraph(e,l),e.isLoading=!1}),e.$on("timerEvent:stopped",function(){s.cancel(n.timer)}),e.getdate=function(e){return e?e=e.getFullYear()+"-"+("0"+(e.getMonth()+1)).slice(-2)+"-"+("0"+e.getDate()).slice(-2):void 0},e.graphready=function(t){e.graphLoading=!1}}]).controller("AppCtrl",["$scope","$state","USER_ROLES","$rootScope",function(e,t,r,a){e.userRoles=r,t.go("app.dashboard"),e.showModal=!1}]).controller("DashboardCtrl",["$rootScope","$scope","$state","$interval","sessionService","$http",function(e,t,r,a,n,o){}]).controller("deviceStatusCtrl",["$scope","UpdateService","notify","$interval",function(e,t,r,a){e.statusToggle=function(){if(1==e.device.Status){var n={_id:e.device._id,status:0};t.deviceStatus("update/deviceStatus",n).then(function(){e.device.Status=0,a(r({message:"Device #"+e.device._id+" De-Activated",classes:"alert-danger",duration:"10000",position:"right"}),1e3)})}else{var n={_id:e.device._id,status:1};t.deviceStatus("update/deviceStatus",n).then(function(){e.device.Status=1,a(r({message:"Device #"+e.device._id+" Activated",classes:"color:green",duration:"10000",position:"right"}),1e3)})}}}]).controller("FriendlyNameEditorCtrl",["$scope","$uibModalInstance","selectedDevice","UpdateService","notify","$interval",function(e,t,r,a,n,o){e.selectedDevice=r,e.ok=function(){var r={_id:e.selectedDevice._id,newname:e.editFname.fname.$modelValue};a.deviceStatus("update/fname",r).then(function(r){e.selectedDevice.name=e.editFname.fname.$modelValue,t.close(),o(n({message:"Device Name updated for #"+e.selectedDevice._id,duration:"10000",position:"right"}),1e3)},function(e){alert("Update failed")})},e.cancel=function(){t.dismiss("cancel")}}]).controller("LoginCtrl",["$scope","$rootScope","Notification","$state","LoginService","sessionService",function(e,t,r,a,n,o){e.credentials={username:"",password:""},e.login=function(e){n.login(e).then(function(e){e||r.error({title:"Login Failed",message:"Incorrect Credentials",delay:4e3}),t.details=e.data.details,a.go("app")},function(e){console.log(e)})}}]).controller("NavCtrl",["$rootScope","$scope","$state","$interval","sessionService","$http",function(e,t,r,a,n,o){t.logout=function(){var e=sessionStorage.getItem("user");n.destroy(e),o.defaults.headers.common["X-Auth-Token"]=void 0,o.defaults.headers.common.Bearer=void 0,r.go("login",{},{reload:!0})};var i=sessionStorage.getItem("user");i&&(t.userName=i)}]).controller("rawDataCtrl",["$scope","userFactory","$state","$rootScope",function(e,t,r,a){e.refresh=function(){t.receive("fetch/getrawdata").then(function(t){var r=t;e.rawdata=r},function(e){console.log(e)})},e.refresh()}]).controller("TimeCtrl",["$scope","$timeout",function(e,t){e.clock="loading clock...",e.tickInterval=1e3;var r=function(){e.clock=Date.now(),t(r,e.tickInterval)};t(r,e.tickInterval)}]).run(["$rootScope","$state","LoginService","sessionService","$http","$interval",function(e,t,r,a,n,o){e.$on("$stateChangeStart",function(r,i,s,l,c){var u=function(){o.cancel(e.timer)};if(u(),"login"!==i.name){var d=sessionStorage.getItem("reqTok"),p=sessionStorage.getItem("user");d&&p?(n.defaults.headers.post={"Content-Type":"application/x-www-form-urlencoded"},n.defaults.headers.get={"Content-Type":"application/json"},n.defaults.headers.common["X-Auth-Token"]=d,n.defaults.headers.common.Bearer=p):(r.preventDefault(),a.destroy("user"),n.defaults.headers.common["X-Auth-Token"]=void 0,n.defaults.headers.common.Bearer=void 0,t.go("login"))}})}]).factory("device",["$http","$q","reqInspect",function(e,t,r){return{all:function(r){var a=t.defer();return e({url:"http://www.smartafarm.com.au/api/fetch/getdevices",method:"GET"}).then(function(e){a.resolve(e.data)},function(e){a.reject(e)}),a.promise}}}]).factory("Poller",["$http","$q","reqInspect",function(e,t,r){return{poll:function(r){var a=t.defer();return e.get(r).then(function(e){a.resolve(e.data)},function(e){return a.reject()}),a.promise}}}]).factory("mygraphFactory",function(){return{googleGraph:function(e,t){e.graphTemprature={},e.graphLevel={};var r=-1,a={},n={};angular.forEach(e.data,function(t,o){r+=1;var i=!1;e.graphTemprature[r]={},e.graphTemprature[r].data={},e.graphLevel[r]={},e.graphLevel[r].data={},e.graphTemprature[r].data={cols:[{id:"t",label:"Time",type:"datetime"},{id:"t01",label:"T01",type:"number"},{id:"t01",label:"T02",type:"number"}]},e.graphLevel[r].data={cols:[{id:"t",label:"Time",type:"date"},{id:"t01",label:"T01",type:"number"},{id:"l01",label:"L01",type:"number"}]},e.graphTemprature[r].data.rows={},e.graphLevel[r].data.rows={};a.rows=[],temp1=[],n.rows=[];var s=-1;angular.forEach(t.readings,function(e,t){s+=1;var r=new Date(e.dt);c=r.getDate()+"/"+r.getMonth()+"/"+r.getFullYear()+r.getHours()+":"+r.getMinutes(),a.rows[s]=[],a.rows[s].c=[],a.rows[s].c.push({v:r}),n.rows[s]=[],n.rows[s].c=[],n.rows[s].c.push({v:r}),angular.forEach(e.data,function(t,a){e.data.sensorID,r.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1");angular.forEach(t.sdata,function(e,t){n.rows[s].c.push({v:parseFloat(e.value)/10})})})}),e.graphTemprature[r].data.rows=a.rows,e.graphLevel[r].data.rows=n.rows,e.graphTemprature[r].type="AreaChart",e.graphLevel[r].type="AnnotationChart",1==i&&(e.graphTemprature[r].data.cols.push({id:"t02",label:"Temp 02 ",type:"number"}),e.graphLevel[r].data.cols.push({id:"l02",label:"Level 02 ",type:"number"}));var l=new Date,c=new Date(l.getFullYear(),l.getMonth(),l.getDate());e.graphLevel[r].options={title:"Level",crosshair:{trigger:"both"},fill:20,animation:{startup:!0,duration:400,easing:"inAndOut"},chartArea:{backgroundColor:{stroke:"blue"}},colors:["blue","green"],pointSize:10,zoomStartTime:c,zoomEndTime:l,displayAnnotations:!1,displayAnnotationsFilter:!1,displayLegendDots:!1,scaleColumns:[1,2],scaleType:"allmaximized",table:{sortAscending:!1},vAxis:{title:"time"},min:0,displayLegends:!1,legendPosition:"newRow",dateFormat:"hh:mm a dd-MM-yy",select:function(){console.log("hello")}}})}}}).factory("LoginService",["$http","$q",function(e,t){return{login:function(r){var a=t.defer();return e({headers:{"Content-Type":"application/x-www-form-urlencoded"},url:"http://localhost/api/login/authenticate",method:"POST",data:{credentials:r}}).then(function(e){e&&(sessionStorage.setItem("user",e.data.id),sessionStorage.setItem("reqTok",e.data.token)),a.resolve(e)},function(e){a.reject(e)}),a.promise},isAuth:function(r,a){var n=t.defer();return e({url:"http://www.smartafarm.com.au/api/login/validate",method:"POST",data:{data:{user:a,token:r}}}).then(function(e){n.resolve(e.data)},function(e){n.reject("Failed")}),n.promise},destroy:function(r){var a=t.defer();return e({url:"http://www.smartafarm.com.au/api/login/destroy",method:"POST",data:{user:r}}).then(function(e){a.resolve(e.data)},function(e){a.reject("Failed")}),a.promise}}}]).factory("reqInspect",["$injector",function(e){return{responseError:function(t){if(401===t.status){var r=e.get("sessionService"),a=e.get("$http"),n=e.get("$state");r.destroy(),a.defaults.headers.common["X-Auth-Token"]=void 0,a.defaults.headers.common.Bearer=void 0,n.go("login")}}}}]).factory("sessionService",["LoginService","$interval","$rootScope",function(e,t,r){return{set:function(e,t){return sessionStorage.setItem(e,t)},get:function(e){return sessionStorage.getItem(e)},destroy:function(){r.$broadcast("timerEvent:stopped");var t=sessionStorage.getItem("user");e.destroy(t),sessionStorage.removeItem("user"),sessionStorage.removeItem("reqTok")}}}]).factory("UpdateService",["$http","$q",function(e,t){return{deviceStatus:function(r,a){var n=t.defer();return e({url:"http://www.smartafarm.com.au/api/"+r,method:"POST",data:{serverData:a}}).then(function(e){n.resolve(e.data)},function(e){n.reject("Failed")}),n.promise}}}]).factory("userFactory",["$http","$q",function(e,t){return{receive:function(r){var a=t.defer();return e({url:"http://www.smartafarm.com.au/api/"+r,method:"GET"}).then(function(e){a.resolve(e.data)},function(e){a.reject("Failed")}),a.promise},submit:function(r,a){var n=t.defer();return e({url:"http://www.smartafarm.com.au/api/"+r,method:"POST",data:{serverData:a}}).then(function(e){n.resolve(e)},function(e){n.reject("Failed")}),n.promise}}}]);